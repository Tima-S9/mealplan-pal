{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-lg border-0">
        <div class="card-body p-4">
          <h2 class="card-title mb-4 text-center">
            {% if recipe %}<i class="bi bi-pencil-square"></i> Edit Recipe{% else %}<i class="bi bi-plus-circle"></i> Create Recipe{% endif %}
          </h2>
          <ul class="nav nav-tabs mb-3" id="recipeTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab" aria-controls="details" aria-selected="true">Details</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="ingredients-tab" data-bs-toggle="tab" data-bs-target="#ingredients" type="button" role="tab" aria-controls="ingredients" aria-selected="false">Ingredients</button>
            </li>
          </ul>
          <form method="post" enctype="multipart/form-data">
            {% if formset.management_form.errors %}
              <div class="alert alert-warning">
                <strong>Formset Management Errors:</strong>
                <ul>
                  {% for error in formset.management_form.errors.values %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            {% for hidden in formset.hidden_fields %}
              {% for error in hidden.errors %}
                <div class="alert alert-warning">
                  <strong>Hidden field error:</strong> {{ error }}
                </div>
              {% endfor %}
            {% endfor %}
            {% if form.errors %}
              <div class="alert alert-danger">
                <strong>There were errors in your form:</strong>
                <ul>
                  {% for field in form %}
                    {% for error in field.errors %}
                      <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                  {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            {% if formset.errors %}
              <div class="alert alert-danger">
                <strong>There were errors in your ingredients:</strong>
                <ul>
                  {% for form in formset.forms %}
                    {% for field in form.visible_fields %}
                      {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                      {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            {% csrf_token %}
            <div class="tab-content" id="recipeTabContent">
              <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                <div class="mb-3">
                  <label for="id_title" class="form-label"><i class="bi bi-card-text"></i> Title</label>
                  {{ form.title }}
                </div>
                <div class="mb-3">
                  <label for="id_description" class="form-label"><i class="bi bi-align-left"></i> Description</label>
                  {{ form.description }}
                </div>
                <div class="mb-3">
                  <label for="id_image" class="form-label"><i class="bi bi-image"></i> Image</label>
                  {{ form.image }}
                </div>
                <div class="mb-3">
                  <label for="id_is_public" class="form-label"><i class="bi bi-globe"></i> Public</label>
                  {{ form.is_public }}
                </div>
                {% if form.calories %}
                <div class="mb-3">
                  <label for="id_calories" class="form-label"><i class="bi bi-fire"></i> Calories</label>
                  {{ form.calories }}
                </div>
                {% endif %}
              </div>
              <div class="tab-pane fade" id="ingredients" role="tabpanel" aria-labelledby="ingredients-tab">
                <div class="border rounded p-3 bg-light mb-3">
                  <h5 class="mb-3"><i class="bi bi-list-check"></i> Ingredients & Amounts</h5>
                  {{ formset.management_form }}
                  {# Render all hidden fields for all forms here to guarantee submission #}
                  {% for ing_form in formset %}
                    {% for hidden in ing_form.hidden_fields %}
                      {{ hidden }}
                    {% endfor %}
                  {% endfor %}
                  <table class="table table-bordered align-middle" id="ingredients-table">
                    <thead>
                      <tr>
                        <th>Ingredient</th>
                        <th>Amount</th>
                        <th>Delete?</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for ing_form in formset %}
                        <tr>
                          {# Render all hidden fields for this form #}
                          {% for hidden in ing_form.hidden_fields %}
                            <td style="display:none">{{ hidden }}</td>
                          {% endfor %}
                          <td>{{ ing_form.ingredient }}</td>
                          <td>{{ ing_form.amount }}</td>
                          <td>{% if ing_form.instance.pk %}{{ ing_form.DELETE }}{% endif %}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                  <small class="text-muted">Add, edit, or remove ingredients and their amounts for this recipe.</small>
                  <div class="d-grid mt-3">
                    <button type="button" class="btn btn-outline-success" id="confirm-ingredients-btn">Confirm Ingredients</button>
                  </div>
                  <div id="ingredients-summary" class="alert alert-info mt-3 d-none">
                    <strong>Current Ingredients:</strong>
                    <ul id="ingredients-list"></ul>
                  </div>
                </div>
                <div class="border rounded p-3 bg-white mb-3 mt-4">
                  <h6 class="mb-2"><i class="bi bi-plus-circle"></i> Add ingredient not listed above</h6>
                  <div class="input-group mb-2">
                    <input type="text" class="form-control" name="new_ingredient" placeholder="Enter new ingredient name">
                    <input type="text" class="form-control" name="new_ingredient_unit" placeholder="Unit (e.g. g, pcs)">
                    <input type="number" step="any" class="form-control" name="new_ingredient_amount" placeholder="Amount">
                  </div>
                  <small class="text-muted">If your ingredient is not listed, add it here and it will be included in your recipe.</small>
                </div>
              </div>
            </div>
            <div class="d-grid mt-4">
              <button type="submit" class="btn btn-primary btn-lg">{% if recipe %}Update Recipe{% else %}Create Recipe{% endif %}</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    var triggerTabList = [].slice.call(document.querySelectorAll('#recipeTab button'));
    triggerTabList.forEach(function (triggerEl) {
      var tabTrigger = new bootstrap.Tab(triggerEl);
      triggerEl.addEventListener('click', function (event) {
        event.preventDefault();
        tabTrigger.show();
      });
    });

    // Confirm Ingredients button logic (robust for select or text input)
    var confirmBtn = document.getElementById('confirm-ingredients-btn');
    if (confirmBtn) {
      confirmBtn.addEventListener('click', function() {
        var table = document.getElementById('ingredients-table');
        var rows = table.querySelectorAll('tbody tr');
        var summary = document.getElementById('ingredients-summary');
        var list = document.getElementById('ingredients-list');
        list.innerHTML = '';
        var hasIngredients = false;
        rows.forEach(function(row) {
          // Find ingredient field (select or text input with name containing 'ingredient')
          var ing = row.querySelector('select[name*="ingredient"], input[type="text"][name*="ingredient"]');
          // Find amount field (number input or text input with name containing 'amount')
          var amt = row.querySelector('input[type="number"], input[type="text"][name*="amount"]');
          if (ing && amt && ing.value && amt.value) {
            var text = ing.tagName === 'SELECT' ? ing.options[ing.selectedIndex].text : ing.value;
            list.innerHTML += '<li>' + text + ' (' + amt.value + ')</li>';
            hasIngredients = true;
          }
        });
        if (hasIngredients) {
          summary.classList.remove('d-none');
        } else {
          summary.classList.add('d-none');
        }
      });
    }
  });
</script>
{% endblock %}
